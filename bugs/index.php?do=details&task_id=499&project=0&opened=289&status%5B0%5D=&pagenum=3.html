<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-AU" xml:lang="en-AU">
  <head>
    <title>FS#499 : High c.titlebar.border_width breaks</title>

    <meta name="description" content="Flyspray, a Bug Tracking System written in PHP." />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Script-Type" content="text/javascript" />
    <meta http-equiv="Content-Style-Type" content="text/css" />

    <link rel="icon" type="image/png" href="https://awesomewm.org/bugs/themes/Bluey/favicon.ico" />
    <link rel="index" id="indexlink" type="text/html" href="https://awesomewm.org/bugs/" />
        <link media="screen" href="https://awesomewm.org/bugs/themes/Bluey/theme.css" rel="stylesheet" type="text/css" />
    <link media="print"  href="https://awesomewm.org/bugs/themes/Bluey/theme_print.css" rel="stylesheet" type="text/css" />
    <link rel="alternate" type="application/rss+xml" title="Flyspray RSS 1.0 Feed"
          href="https://awesomewm.org/bugs/feed.php?feed_type=rss1&amp;project=1" />
    <link rel="alternate" type="application/rss+xml" title="Flyspray RSS 2.0 Feed"
          href="https://awesomewm.org/bugs/feed.php?feed_type=rss2&amp;project=1" />
	<link rel="alternate" type="application/atom+xml" title="Flyspray Atom 0.3 Feed"
	      href="https://awesomewm.org/bugs/feed.php?feed_type=atom&amp;project=1" />

    <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/prototype/prototype.js"></script>
    <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/script.aculo.us/scriptaculous.js"></script>
            <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/details.js"></script>
                <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/tabs.js"></script>
    <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/functions.js"></script>
    <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/jscalendar/calendar_stripped.js"></script>
    <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/jscalendar/calendar-setup_stripped.js"> </script>
    <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/jscalendar/lang/calendar-en.js"></script>
    <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/lightbox/js/lightbox.js"></script>
    <link rel="stylesheet" href="https://awesomewm.org/bugs/javascript/lightbox/css/lightbox.css" type="text/css" media="screen" />
    <!--[if IE]>
    <link media="screen" href="https://awesomewm.org/bugs/themes/Bluey/ie.css" rel="stylesheet" type="text/css" />
    <![endif]-->
      </head>
  <body onload="perms = new Perms('permissions');">

  <div id="container">
    <!-- Remove this to remove the logo -->
    <h1 id="title"><a href="https://awesomewm.org/bugs/">awesome</a></h1>

    <div id="menu">

<form id="login" action="https://awesomewm.org/bugs/index.php?do=authenticate" method="post">
<div>
  <label for="lbl_user_name">Username</label>
  <input class="text" type="text" id="lbl_user_name" name="user_name" size="17" maxlength="30" />

  <label for="lbl_password">Password</label>
  <input class="password" type="password" id="lbl_password" name="password" size="17" maxlength="30" />

  <label for="lbl_remember">Remember me</label>
  <input type="checkbox" id="lbl_remember" name="remember_login" />
  
  <input type="hidden" name="return_to" value="/bugs/index.php?do=details&amp;task_id=499&amp;project=0&amp;opened=289&amp;status%5B0%5D=&amp;pagenum=3" />

  <button accesskey="l" type="submit">Login!</button>

  <span id="links">
            <a id="forgotlink" href="https://awesomewm.org/bugs/index.php?do=lostpw">Lost password?</a>
      </span>
</div>
</form>
</div>

<div id="pm-menu">

<div id="projectselector">
    <form id="projectselectorform" action="https://awesomewm.org/bugs/index.php" method="get">
       <div>
        <select name="project" onChange="document.getElementById('projectselectorform').submit()">
          <option value="0">All Projects</option>        </select>
        <button type="submit">Switch</button>
        <input type="hidden" name="do" value="details" />
        <input type="hidden" value="1" name="switch" />
              </div>
    </form>
</div>

<ul id="pm-menu-list">
    <li class="first">
      <a id="toplevellink" href="https://awesomewm.org/bugs/index.php?do=toplevel&amp;project=1">Overview</a>
    </li>

    <li>
    <a id="homelink"
        href="https://awesomewm.org/bugs/index.php?project=1&amp;do=index">Tasklist</a>
    </li>

    
    
        <li>
    <a id="roadmaplink"
        href="https://awesomewm.org/bugs/index.php?do=roadmap&amp;project=1">Roadmap</a>
    </li>
    
    
    </ul>
</div>

    
    <div id="content">
      <div id="showtask">
        <form action="https://awesomewm.org/bugs/index.php" method="get">
          <div>
            <button type="submit">Show Task #</button>
            <input id="taskid" name="show_task" class="text" type="text" size="10" accesskey="t" />
          </div>
        </form>
      </div>

      <div class="clear"></div>
            <div id="intromessage">Welcome to awesome bug tracking system.</div>
      <div id="taskdetails">
<span id="navigation">   <del>&#160;<a href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=511&amp;project=0&amp;opened=289&amp;status%5B0%5D=&amp;pagenum=3" title="Fixed | awesome generatess needless ConfigureNotify events  | 100%"  id = "prev" accesskey = "p" class = "closedtasklink">Previous task</a>&#160;</del>     |     <a href="https://awesomewm.org/bugs/index.php?project=1&amp;do=index&amp;opened=289&amp;status%5B0%5D=&amp;pagenum=3">Tasklist</a>
   |     <del>&#160;<a href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=494&amp;project=0&amp;opened=289&amp;status%5B0%5D=&amp;pagenum=3" title="Not a bug | windows disappear after restart if less tags than before are cre | 100%"  id = "next" accesskey = "n" class = "closedtasklink">Next task</a>&#160;</del>  </span>

  <h2 class="summary severity2">
	 FS#499 - High c.titlebar.border_width breaks  </h2>

  <div id="fineprint">
	 Attached to Project:
	 <a href="/bugs/index.php?project=1">awesome</a>
	 <br />
	 Opened by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=289">Uli Schlachter (psychon)</a>     	 - Saturday, 18 April 2009, 12:52 GMT 	 	 <br />
	 Last edited by  <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=1">Julien Danjou (jd)</a>	 - Saturday, 21 November 2009, 09:48 GMT 	   </div>

  <table><tr><td id="taskfieldscell">
  <div id="taskfields">
	 <table>
		<tr>
		  <th id="tasktype">Task Type</th>
		  <td headers="tasktype">Bug Report</td>
		</tr>
		<tr>
		  <th id="category">Category</th>
		  <td headers="category">
			 			 Core		  </td>
		</tr>
		<tr>
		  <th id="status">Status</th>
		  <td headers="status">
			 			 Closed			 		  </td>
		</tr>
		<tr>
		  <th id="assignedto">Assigned To</th>
		  <td headers="assignedto">
			 			 No-one			 		  </td>
		</tr>
		<tr>
		  <th id="os">Operating System</th>
		  <td headers="os">All</td>
		</tr>
		<tr>
		  <th id="severity">Severity</th>
		  <td headers="severity">Low</td>
		</tr>
		<tr>
		  <th id="priority">Priority</th>
		  <td headers="priority">Normal</td>
		</tr>
		<tr>
		  <th id="reportedver">Reported Version</th>
		  <td headers="reportedver">git/master</td>
		</tr>
		<tr>
		  <th id="dueversion">Due in Version</th>
		  <td headers="dueversion">
			 			 Undecided			 		  </td>
		</tr>
		<tr>
		  <th id="duedate">Due Date</th>
		  <td headers="duedate">
			 Undecided		  </td>
		</tr>
		<tr>
		  <th id="percent">Percent Complete</th>
		  <td headers="percent">
			 <img src="https://awesomewm.org/bugs/themes/Bluey/percent-100.png"
				title="100% complete"
				alt="100%" />
		  </td>
		</tr>
        <tr class="votes">
		  <th id="votes">Votes</th>
		  <td headers="votes">
                    0
                              </td>
        </tr>
        <tr>
		  <th id="private">Private</th>
		  <td headers="private">
                        No            
                      </td>
        </tr>
        	 </table>
  </div>

  </td><td>

  <div id="taskdetailsfull">
	 <h3 class="taskdesc">Details</h3>
     <div id="taskdetailstext">Hi,<br />
<br />
setting c.titlebar.border_width to a high value (I guess a value bigger than half the titlebar&#039;s height) breaks with lots of &quot;funny&quot; X protocol errors and no usable awesome. This looks like some integer overflow, because the window has a huge titlebar height. I think I remember something similar for wiboxes...<br />
<br />
psychon<br />
<br />
Excerpt of error output:<br />
W: awesome: xerror:288: X error: request=CreatePixmap, error=BadAlloc<br />
W: awesome: xerror:288: X error: request=CopyArea, error=BadDrawable<br />
W: awesome: xerror:288: X error: request=CopyArea, error=BadDrawable<br />
W: awesome: xerror:288: X error: request=FreePixmap, error=BadPixmap<br />
W: awesome: xerror:288: X error: request=CreatePixmap, error=BadAlloc<br />
W: awesome: xerror:288: X error: request=(null), error=BadDrawable<br />
W: awesome: xerror:288: X error: request=(null), error=(null)<br />
W: awesome: xerror:288: X error: request=CreatePixmap, error=BadDrawable<br />
W: awesome: xerror:288: X error: request=(null), error=BadDrawable<br />
....<br />
<br />
diff --git a/awesomerc.lua.in b/awesomerc.lua.in<br />
index 483d671..73f1fac 100644<br />
--- a/awesomerc.lua.in<br />
+++ b/awesomerc.lua.in<br />
@@ -362,10 +360,11 @@ awful.hooks.manage.register(function (c, startup)<br />
         c.screen = mouse.screen<br />
     end<br />
 <br />
-    if use_titlebar then<br />
-        -- Add a titlebar<br />
-        awful.titlebar.add(c, { modkey = modkey })<br />
-    end<br />
+    -- Add a titlebar<br />
+    awful.titlebar.add(c, { modkey = modkey })<br />
+    c.titlebar.border_width = 10<br />
+    c.titlebar.border_color = &quot;red&quot;<br />
+<br />
     -- Add mouse bindings<br />
     c:buttons(awful.util.table.join(<br />
         awful.button({ }, 1, function (c) client.focus = c; c:raise() end),</div>

       
  </div>

  </td></tr></table>

  <div id="taskinfo">
	 <div id="taskdeps">
		<b>This task depends upon</b>
		<br />
		
		<br class="DoNotPrint" />

		
			 </div>

	 <div id="taskblocks">
        			 </div>
  </div>

    <div id="taskclosed">
      Closed by&nbsp;&nbsp;<a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=1">Julien Danjou (jd)</a><br />
      Saturday, 21 November 2009, 09:48 GMT <br />
      <strong>Reason for closing:</strong> &nbsp;Fixed<br />
            <strong>Additional comments about closing:</strong> &nbsp;commit
b097266925129e6999bfeae6a3d51799fe723ddb
<br />
Author: Hiltjo Posthuma
&lt;hiltjo@codemadness.org&gt;<br />
Date:   Wed Nov 18 14:22:50 2009
+0100<br />
<br />
    awful.menu: use actual wibox border
width<br />
    <br />
    We check the wibox border width for
inappropiate values now, if we set<br
/>
    border_width to a negative value
(invalid) in our theme and draw it,
the<br />
    actual border_width will be 0 so the
menu will be drawn incorrectly.<br />
    This fixed this.<br />
    <br />
    Signed-off-by: Hiltjo Posthuma
&lt;hiltjo@codemadness.org&gt;<br />
    Signed-off-by: Julien Danjou
&lt;julien@danjou.info&gt;<br />
<br />
commit
a56e1b11d326a108af6a05591faeda46e1b75340
<br />
Author: Julien Danjou
&lt;julien@danjou.info&gt;<br />
Date:   Sat Nov 21 10:45:37 2009
+0100<br />
<br />
    wibox: check border width<br />
    <br />
    Signed-off-by: Julien Danjou
&lt;julien@danjou.info&gt;<br />
<br />        </div>
  
  <div id="actionbuttons">
	 
	 
	 	   </div>
</div>
<ul id="submenu">
    <li id="commentstab">
  <a href="#comments">Comments (5)</a>
  </li>
  
  <li id="relatedtab">
  <a href="#related">Related Tasks (0/0)</a>
  </li>

  
  </ul>
<div id="comments" class="tab">
    <em>
    <a name="comment1184" id="comment1184"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=499#comment1184">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=209">Maarten Maathuis (madman2003)</a> -
    Saturday, 18 April 2009, 13:08 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">The code is probably not shielded against zero/negative width/height titlebars. Border width is included in the total width, so a large border leaves nothing for the actual titlebar.</div></div>

  
    <em>
    <a name="comment1185" id="comment1185"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=499#comment1185">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=209">Maarten Maathuis (madman2003)</a> -
    Saturday, 18 April 2009, 13:10 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">It&#039;s even possible that some of the titlebar code assumes no border. Maybe someone should check that, i can&#039;t in the forseeable future.</div></div>

  
    <em>
    <a name="comment1529" id="comment1529"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=499#comment1529">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=395">Hiltjo (bob127)</a> -
    Wednesday, 18 November 2009, 14:54 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">Possibly related: setting a negative border width on wiboxes in your theme will set the border width to a very high value (integer overflow). I think when a negative value is specified it should ignore it.<br />
<br />
Xtrace output:<br />
<br />
-- snip snip --<br />
000:&gt;:03c7: Event CreateNotify(16) parent=0x00000103 window=0x00800046 x=0 y=0 width=1 height=1 border-width=65521 override-redirect=true(0x01)<br />
000:&gt;:03c7: Event PropertyNotify(28) window=0x00800046 atom=0x15a(&quot;_NET_WM_WINDOW_OPACITY&quot;) time=0x00ef8691 state=NewValue(0x00)<br />
000:&gt;:03c7: Event PropertyNotify(28) window=0x00800046 atom=0x139(&quot;_NET_WM_STRUT_PARTIAL&quot;) time=0x00ef8691 state=NewValue(0x00)<br />
000:&gt;:03c7: Event ConfigureNotify(22) event=0x00800046 window=0x00800046 above-sibling=0x00800001 x=0 y=0 width=123 height=13 border-width=65521 override-redirect=true(0x01)<br />
000:&gt;:03c7: Event ConfigureNotify(22) event=0x00000103 window=0x00800046 above-sibling=0x00800001 x=0 y=0 width=123 height=13 border-width=65521 override-redirect=true(0x01)<br />
000:&gt;:03c7:32: Reply to QueryPointer: same-screen=true(0x01) root=0x00000103 child=0x00800004 root-x=1171 root-y=1007 win-x=1171 win-y=1007 mask=Mod2<br />
000:&lt;:03c8: 20: Request(12): ConfigureWindow window=0x00800046 values={x=1109 y=1000}<br />
000:&lt;:03c9: 16: Request(12): ConfigureWindow window=0x00800046 values={y=993}<br />
000:&lt;:03ca:  8: Request(8): MapWindow window=0x00800046<br />
000:&lt;:03cb: 24: Request(20): GetProperty delete=false(0x00) window=0x00800046 property=0x15a(&quot;_NET_WM_WINDOW_OPACITY&quot;) type=any(0x0) long-offset=0x00000000 long-length=0x00000001<br />
000:&gt;:03cb: Event ConfigureNotify(22) event=0x00800046 window=0x00800046 above-sibling=0x00800001 x=1109 y=1000 width=123 height=13 border-width=65521 override-redirect=true(0x01)<br />
000:&gt;:03cb: Event ConfigureNotify(22) event=0x00000103 window=0x00800046 above-sibling=0x00800001 x=1109 y=1000 width=123 height=13 border-width=65521 override-redirect=true(0x01)<br />
000:&gt;:03cb: Event ConfigureNotify(22) event=0x00800046 window=0x00800046 above-sibling=0x00800001 x=1109 y=993 width=123 height=13 border-width=65521 override-redirect=true(0x01)<br />
000:&gt;:03cb: Event ConfigureNotify(22) event=0x00000103 window=0x00800046 above-sibling=0x00800001 x=1109 y=993 width=123 height=13 border-width=65521 override-redirect=true(0x01)<br />
-- snip snip --<br />
<br />
I attached 2 patches which fix it for me (against v3.4.1), can anyone please test these patches ?</div></div>

      <div class="attachments">
          <a title="0001-Wibox-check-border-width.patch" href="?getfile=247" >
                <img src="https://awesomewm.org/bugs/themes/Bluey/mime/text.png" alt="" title="text/plain" />
            &nbsp;&nbsp;
            0001-Wibox-check-border-width...
                  </a>
                  (1.2 KiB)
          <br />
          <a title="0002-Menu.lua-use-actual-wibox-border-width.patch" href="?getfile=248" >
                <img src="https://awesomewm.org/bugs/themes/Bluey/mime/text.png" alt="" title="text/plain" />
            &nbsp;&nbsp;
            0002-Menu.lua-use-actual-wibo...
                  </a>
                  (1.1 KiB)
          <br />
    </div>
  

    <em>
    <a name="comment1534" id="comment1534"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=499#comment1534">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=289">Uli Schlachter (psychon)</a> -
    Friday, 20 November 2009, 19:06 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">No idea about the second patch, but the first one doesn&#039;t look too bad to me (anybody who manages to get an integer overflow on an int32_t for his border width deserves what he gets).<br />
<br />
Perhaps a lua_warn() would be nice if someone sets and invalid border width?<br />
Would it be acceptable to use lua_number instead of int32_t? According to google, this is what luaL_checknumber() returns.</div></div>

  
    <em>
    <a name="comment1535" id="comment1535"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=499#comment1535">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=395">Hiltjo (bob127)</a> -
    Friday, 20 November 2009, 22:59 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">lua_Number is a double by default (see /usr/include/luaconf.h), this is wrong for setting as the border width. <br />
<br />
I agree setting a very high or negative border width is a silly thing to do :)<br />
<br />
Maybe I should make a separate bug posting for the menu. But the second patch isn&#039;t all that useful without the first one since negative borders break anyway. The second patch makes sure to use the actual set wibox border width, not the (possibly wrong) value in the theme.</div></div>

  
  
  </div>
<div id="related" class="tab">
  <table>    <tr><td>
    <form method="post" action="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=499#related" >
        <table id="tasks_related" class="userlist">
        <tr>
          <th>
            <a href="javascript:ToggleSelected('tasks_related')">
              <img title="Toggle Selected" alt="Toggle Selected" src="https://awesomewm.org/bugs/themes/Bluey/kaboodleloop.png" width="16" height="16" />
            </a>
          </th>
          <th>Tasks related to this task (0)</th>
        </tr>
                <tr>
          <td colspan="2">
            <input type="hidden" name="action" value="remove_related" />
            <input type="hidden" name="task_id" value="499" />
            <button type="submit">Remove</button>
          </td>
        </tr>
        </table>
    </form>
    </td><td>
    
    <table id="duplicate_tasks" class="userlist">
        <tr>
          <th>Duplicate tasks of this task (0)</th>
        </tr>
            </table>
    </td></tr>
  </table>

  </div>
<div id="history" class="tab">
  <h3>Loading...</h3>
</div>
    </div>
    <p id="footer">
       <!-- Please don't remove this line - it helps promote Flyspray -->
       <a href="http://flyspray.org/" class="offsite">Powered by Flyspray</a>
    </p>
  </div>
  </body>
</html>
