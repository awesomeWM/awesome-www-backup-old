<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-AU" xml:lang="en-AU">
  <head>
    <title>FS#1023 : Lets get rid of awsetbg</title>

    <meta name="description" content="Flyspray, a Bug Tracking System written in PHP." />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Script-Type" content="text/javascript" />
    <meta http-equiv="Content-Style-Type" content="text/css" />

    <link rel="icon" type="image/png" href="https://awesomewm.org/bugs/themes/Bluey/favicon.ico" />
    <link rel="index" id="indexlink" type="text/html" href="https://awesomewm.org/bugs/" />
        <link media="screen" href="https://awesomewm.org/bugs/themes/Bluey/theme.css" rel="stylesheet" type="text/css" />
    <link media="print"  href="https://awesomewm.org/bugs/themes/Bluey/theme_print.css" rel="stylesheet" type="text/css" />
    <link rel="alternate" type="application/rss+xml" title="Flyspray RSS 1.0 Feed"
          href="https://awesomewm.org/bugs/feed.php?feed_type=rss1&amp;project=1" />
    <link rel="alternate" type="application/rss+xml" title="Flyspray RSS 2.0 Feed"
          href="https://awesomewm.org/bugs/feed.php?feed_type=rss2&amp;project=1" />
	<link rel="alternate" type="application/atom+xml" title="Flyspray Atom 0.3 Feed"
	      href="https://awesomewm.org/bugs/feed.php?feed_type=atom&amp;project=1" />

    <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/prototype/prototype.js"></script>
    <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/script.aculo.us/scriptaculous.js"></script>
            <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/details.js"></script>
                <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/tabs.js"></script>
    <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/functions.js"></script>
    <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/jscalendar/calendar_stripped.js"></script>
    <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/jscalendar/calendar-setup_stripped.js"> </script>
    <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/jscalendar/lang/calendar-en.js"></script>
    <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/lightbox/js/lightbox.js"></script>
    <link rel="stylesheet" href="https://awesomewm.org/bugs/javascript/lightbox/css/lightbox.css" type="text/css" media="screen" />
    <!--[if IE]>
    <link media="screen" href="https://awesomewm.org/bugs/themes/Bluey/ie.css" rel="stylesheet" type="text/css" />
    <![endif]-->
      </head>
  <body onload="perms = new Perms('permissions');">

  <div id="container">
    <!-- Remove this to remove the logo -->
    <h1 id="title"><a href="https://awesomewm.org/bugs/">awesome</a></h1>

    <div id="menu">

<form id="login" action="https://awesomewm.org/bugs/index.php?do=authenticate" method="post">
<div>
  <label for="lbl_user_name">Username</label>
  <input class="text" type="text" id="lbl_user_name" name="user_name" size="17" maxlength="30" />

  <label for="lbl_password">Password</label>
  <input class="password" type="password" id="lbl_password" name="password" size="17" maxlength="30" />

  <label for="lbl_remember">Remember me</label>
  <input type="checkbox" id="lbl_remember" name="remember_login" />
  
  <input type="hidden" name="return_to" value="/bugs/index.php?do=details&amp;task_id=1023&amp;opened=630&amp;status%5B0%5D=" />

  <button accesskey="l" type="submit">Login!</button>

  <span id="links">
            <a id="forgotlink" href="https://awesomewm.org/bugs/index.php?do=lostpw">Lost password?</a>
      </span>
</div>
</form>
</div>

<div id="pm-menu">

<div id="projectselector">
    <form id="projectselectorform" action="https://awesomewm.org/bugs/index.php" method="get">
       <div>
        <select name="project" onChange="document.getElementById('projectselectorform').submit()">
          <option value="0">All Projects</option>        </select>
        <button type="submit">Switch</button>
        <input type="hidden" name="do" value="details" />
        <input type="hidden" value="1" name="switch" />
              </div>
    </form>
</div>

<ul id="pm-menu-list">
    <li class="first">
      <a id="toplevellink" href="https://awesomewm.org/bugs/index.php?do=toplevel&amp;project=1">Overview</a>
    </li>

    <li>
    <a id="homelink"
        href="https://awesomewm.org/bugs/index.php?project=1&amp;do=index">Tasklist</a>
    </li>

    
    
        <li>
    <a id="roadmaplink"
        href="https://awesomewm.org/bugs/index.php?do=roadmap&amp;project=1">Roadmap</a>
    </li>
    
    
    </ul>
</div>

    
    <div id="content">
      <div id="showtask">
        <form action="https://awesomewm.org/bugs/index.php" method="get">
          <div>
            <button type="submit">Show Task #</button>
            <input id="taskid" name="show_task" class="text" type="text" size="10" accesskey="t" />
          </div>
        </form>
      </div>

      <div class="clear"></div>
            <div id="intromessage">Welcome to awesome bug tracking system.</div>
      <div id="taskdetails">
<span id="navigation">       <a href="https://awesomewm.org/bugs/index.php?project=1&amp;do=index&amp;opened=630&amp;status%5B0%5D=">Tasklist</a>
   |     <del>&#160;<a href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=1009&amp;opened=630&amp;status%5B0%5D=" title="Not a bug | Awesome with Lua 5.2 leaks memory | 100%"  id = "next" accesskey = "n" class = "closedtasklink">Next task</a>&#160;</del>  </span>

  <h2 class="summary severity2">
	 FS#1023 - Lets get rid of awsetbg  </h2>

  <div id="fineprint">
	 Attached to Project:
	 <a href="/bugs/index.php?project=1">awesome</a>
	 <br />
	 Opened by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=630">Arvydas Sidorenko (Asido)</a>     	 - Monday, 23 July 2012, 18:48 GMT 	 	 <br />
	 Last edited by  <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=289">Uli Schlachter (psychon)</a>	 - Monday, 30 July 2012, 14:32 GMT 	   </div>

  <table><tr><td id="taskfieldscell">
  <div id="taskfields">
	 <table>
		<tr>
		  <th id="tasktype">Task Type</th>
		  <td headers="tasktype">Feature Request</td>
		</tr>
		<tr>
		  <th id="category">Category</th>
		  <td headers="category">
			 			 Core		  </td>
		</tr>
		<tr>
		  <th id="status">Status</th>
		  <td headers="status">
			 			 Closed			 		  </td>
		</tr>
		<tr>
		  <th id="assignedto">Assigned To</th>
		  <td headers="assignedto">
			 			 No-one			 		  </td>
		</tr>
		<tr>
		  <th id="os">Operating System</th>
		  <td headers="os">All</td>
		</tr>
		<tr>
		  <th id="severity">Severity</th>
		  <td headers="severity">Low</td>
		</tr>
		<tr>
		  <th id="priority">Priority</th>
		  <td headers="priority">Normal</td>
		</tr>
		<tr>
		  <th id="reportedver">Reported Version</th>
		  <td headers="reportedver">git/master</td>
		</tr>
		<tr>
		  <th id="dueversion">Due in Version</th>
		  <td headers="dueversion">
			 			 3.5			 		  </td>
		</tr>
		<tr>
		  <th id="duedate">Due Date</th>
		  <td headers="duedate">
			 Undecided		  </td>
		</tr>
		<tr>
		  <th id="percent">Percent Complete</th>
		  <td headers="percent">
			 <img src="https://awesomewm.org/bugs/themes/Bluey/percent-100.png"
				title="100% complete"
				alt="100%" />
		  </td>
		</tr>
        <tr class="votes">
		  <th id="votes">Votes</th>
		  <td headers="votes">
                    0
                              </td>
        </tr>
        <tr>
		  <th id="private">Private</th>
		  <td headers="private">
                        No            
                      </td>
        </tr>
        	 </table>
  </div>

  </td><td>

  <div id="taskdetailsfull">
	 <h3 class="taskdesc">Details</h3>
     <div id="taskdetailstext">The way Awesome sets wallpaper caught my attention recently.`awsetbg` script has really many options to choose from. I am using `feh` and noticed that with multihead setup on around every 1/3 startx `awsetbg` pops me a message that &#039;Something went wrong...&#039;, although visually everything looks ok - the wallpaper is set. By looking further this piece of code caught my attention:<br />
&gt; for s = 1, capi.screen.count() do<br />
&gt;     util.spawn(theme.wallpaper_cmd[util.cycle(#theme.wallpaper_cmd, s)],<br />
&gt; false, s) end<br />
The thing with feh is that it already uses the same loop of screen count if it is configure with xinerama enabled and in those 1/3 times libX11 simply kills the second process spawned by the loop above, awsetbg sees exit status != 0 and pops an error message, while visually everything looks great because the first spawn already did it&#039;s job.<br />
So the question I got is why don&#039;t we set the wallpaper from Awesome itself? We could use libX11 and imlib2, which Awesome already depends on. That would get rid of inconsistent behavior between different background setters, allow to deploy some nice Lua API for wallpaper management and throw awsetbg out.</div>

       
  </div>

  </td></tr></table>

  <div id="taskinfo">
	 <div id="taskdeps">
		<b>This task depends upon</b>
		<br />
		
		<br class="DoNotPrint" />

		
			 </div>

	 <div id="taskblocks">
        			 </div>
  </div>

    <div id="taskclosed">
      Closed by&nbsp;&nbsp;<a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=289">Uli Schlachter (psychon)</a><br />
      Monday, 30 July 2012, 14:32 GMT <br />
      <strong>Reason for closing:</strong> &nbsp;Fixed<br />
            <strong>Additional comments about closing:</strong> &nbsp;commit
ff713470169ff79d686499b20f53d72356730c23
<br />
Author: Uli Schlachter
&lt;psychon@znc.in&gt;<br />
Date:   Sun Jul 29 15:38:31 2012
+0200<br />
<br />
    Remove all traces of awsetbg and
wallpaper setters<br />
    <br />
    Signed-off-by: Uli Schlachter
&lt;psychon@znc.in&gt;<br />        </div>
  
  <div id="actionbuttons">
	 
	 
	 	   </div>
</div>
<ul id="submenu">
    <li id="commentstab">
  <a href="#comments">Comments (5)</a>
  </li>
  
  <li id="relatedtab">
  <a href="#related">Related Tasks (0/0)</a>
  </li>

  
  </ul>
<div id="comments" class="tab">
    <em>
    <a name="comment3129" id="comment3129"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=1023#comment3129">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=1">Julien Danjou (jd)</a> -
    Tuesday, 24 July 2012, 07:34 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">As discussed, we should add root.wallpaper() setting method.</div></div>

  
    <em>
    <a name="comment3130" id="comment3130"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=1023#comment3130">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=289">Uli Schlachter (psychon)</a> -
    Tuesday, 24 July 2012, 18:46 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">Some ugly patch:<br />
<br /><a href="
http://article.gmane.org/gmane.comp.window-managers.awesome.devel/7452">
http://article.gmane.org/gmane.comp.window-managers.awesome.devel/7452</a><br />
<br />
(Actually, I just noticed that intern_atom() is not needed, we can use the atoms from the &quot;main&quot; xcb connection)</div></div>

  
    <em>
    <a name="comment3131" id="comment3131"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=1023#comment3131">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=1">Julien Danjou (jd)</a> -
    Tuesday, 24 July 2012, 20:29 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">We can also use the main XCB connection I guess.</div></div>

  
    <em>
    <a name="comment3132" id="comment3132"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=1023#comment3132">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=630">Arvydas Sidorenko (Asido)</a> -
    Tuesday, 24 July 2012, 20:56 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">That&#039;s some very nice patch, why ugly.<br />
<br />
A few things to note.<br />
&gt; /* FIXME: Shall we do KillClient() on the old pixmap? I think we should. */<br />
Gnome says that if ESETROOT_PMAP_ID is set, it will point to a pixmap that must be killed before changing<br />
ESETROOT_PMAP_ID<br />
And we need some modes to manage the wallpaper based on instead of drawing on the right left corner.</div></div>

  
    <em>
    <a name="comment3133" id="comment3133"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=1023#comment3133">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=289">Uli Schlachter (psychon)</a> -
    Wednesday, 25 July 2012, 06:19 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">@jd: The magic is in the SetCloseDownMode-request. Normally, all our windows and pixmaps get destroyed when we disconnect from the X11 server. However, we obviously want our wallpaper-pixmap to stay alive longer (so that other clients can access it via the root window property). We can&#039;t specify the lifetime of individual objects. However, the SetCloseDownMode-request allows us to say that *everything* that we created should stay alive even after we disconnect. This is why we need the new X11-connection to say that just this pixmap should stay alive. This is also why we need/should do a KillClient on the old background pixmap (if it exists), to delete the stuff that the last wallpaper-setter left behind.<br />
<br />
@Asido 1: Yeah, I don&#039;t think there are any official specs for this, but I found some description on some enlightenment web page which says the same. But I was too lazy to do the needed GetProperty requests. :-)<br />
<br />
@Asido 2: Those modes should be done in lua. Lua code should be shorter and (IMHO) more readable than the equivalent C code (and of course easier to extend). What would be the list of stuff that one would want from a wallpaper setter? Per-screen and &#039;global&#039; wallpaper. Load images and use them centered (with a specified background color), rescaled to fit the whole screen, rescaled while preserving the aspect ratio, tiled. Anything I missed?<br />
The above could be done in a &quot;wallpaper&quot; lua module with functions set(lgi cairo pattern / gears.color-color), set_centered(file, screen, background color), set_tiled(file name, screen), set_maximized(file name, screen, preserve-aspect boolean). (screen can be specified as &#039;nil&#039; to say &#039;across all screens&#039; or &#039;the old awsetbg behavior&#039;.<br />
<br />
Also, some ideas on how the default config gets changed:<br />
- The theme just gets a &quot;wallpaper&quot; or &quot;background&quot; (or sth like that) entry which just specifies a file name<br />
- The code for setting the wallpaper gets moved from beautiful into the default config, it sets the wallpaper per-screen<br />
<br />
That way people can more easily customize the wallpaper from the theme or ignore it completely.<br />
<br />
What do you think?</div></div>

  
  
  </div>
<div id="related" class="tab">
  <table>    <tr><td>
    <form method="post" action="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=1023#related" >
        <table id="tasks_related" class="userlist">
        <tr>
          <th>
            <a href="javascript:ToggleSelected('tasks_related')">
              <img title="Toggle Selected" alt="Toggle Selected" src="https://awesomewm.org/bugs/themes/Bluey/kaboodleloop.png" width="16" height="16" />
            </a>
          </th>
          <th>Tasks related to this task (0)</th>
        </tr>
                <tr>
          <td colspan="2">
            <input type="hidden" name="action" value="remove_related" />
            <input type="hidden" name="task_id" value="1023" />
            <button type="submit">Remove</button>
          </td>
        </tr>
        </table>
    </form>
    </td><td>
    
    <table id="duplicate_tasks" class="userlist">
        <tr>
          <th>Duplicate tasks of this task (0)</th>
        </tr>
            </table>
    </td></tr>
  </table>

  </div>
<div id="history" class="tab">
  <h3>Loading...</h3>
</div>
    </div>
    <p id="footer">
       <!-- Please don't remove this line - it helps promote Flyspray -->
       <a href="http://flyspray.org/" class="offsite">Powered by Flyspray</a>
    </p>
  </div>
  </body>
</html>
