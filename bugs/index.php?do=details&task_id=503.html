<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-AU" xml:lang="en-AU">
  <head>
    <title>FS#503 : awesome &quot;steals&quot; gnome systray even when its systray is disabled</title>

    <meta name="description" content="Flyspray, a Bug Tracking System written in PHP." />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Script-Type" content="text/javascript" />
    <meta http-equiv="Content-Style-Type" content="text/css" />

    <link rel="icon" type="image/png" href="https://awesomewm.org/bugs/themes/Bluey/favicon.ico" />
    <link rel="index" id="indexlink" type="text/html" href="https://awesomewm.org/bugs/" />
        <link media="screen" href="https://awesomewm.org/bugs/themes/Bluey/theme.css" rel="stylesheet" type="text/css" />
    <link media="print"  href="https://awesomewm.org/bugs/themes/Bluey/theme_print.css" rel="stylesheet" type="text/css" />
    <link rel="alternate" type="application/rss+xml" title="Flyspray RSS 1.0 Feed"
          href="https://awesomewm.org/bugs/feed.php?feed_type=rss1&amp;project=1" />
    <link rel="alternate" type="application/rss+xml" title="Flyspray RSS 2.0 Feed"
          href="https://awesomewm.org/bugs/feed.php?feed_type=rss2&amp;project=1" />
	<link rel="alternate" type="application/atom+xml" title="Flyspray Atom 0.3 Feed"
	      href="https://awesomewm.org/bugs/feed.php?feed_type=atom&amp;project=1" />

    <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/prototype/prototype.js"></script>
    <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/script.aculo.us/scriptaculous.js"></script>
            <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/details.js"></script>
                <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/tabs.js"></script>
    <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/functions.js"></script>
    <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/jscalendar/calendar_stripped.js"></script>
    <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/jscalendar/calendar-setup_stripped.js"> </script>
    <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/jscalendar/lang/calendar-en.js"></script>
    <script type="text/javascript" src="https://awesomewm.org/bugs/javascript/lightbox/js/lightbox.js"></script>
    <link rel="stylesheet" href="https://awesomewm.org/bugs/javascript/lightbox/css/lightbox.css" type="text/css" media="screen" />
    <!--[if IE]>
    <link media="screen" href="https://awesomewm.org/bugs/themes/Bluey/ie.css" rel="stylesheet" type="text/css" />
    <![endif]-->
      </head>
  <body onload="perms = new Perms('permissions');">

  <div id="container">
    <!-- Remove this to remove the logo -->
    <h1 id="title"><a href="https://awesomewm.org/bugs/">awesome</a></h1>

    <div id="menu">

<form id="login" action="https://awesomewm.org/bugs/index.php?do=authenticate" method="post">
<div>
  <label for="lbl_user_name">Username</label>
  <input class="text" type="text" id="lbl_user_name" name="user_name" size="17" maxlength="30" />

  <label for="lbl_password">Password</label>
  <input class="password" type="password" id="lbl_password" name="password" size="17" maxlength="30" />

  <label for="lbl_remember">Remember me</label>
  <input type="checkbox" id="lbl_remember" name="remember_login" />
  
  <input type="hidden" name="return_to" value="/bugs/index.php?do=details&amp;task_id=503" />

  <button accesskey="l" type="submit">Login!</button>

  <span id="links">
            <a id="forgotlink" href="https://awesomewm.org/bugs/index.php?do=lostpw">Lost password?</a>
      </span>
</div>
</form>
</div>

<div id="pm-menu">

<div id="projectselector">
    <form id="projectselectorform" action="https://awesomewm.org/bugs/index.php" method="get">
       <div>
        <select name="project" onChange="document.getElementById('projectselectorform').submit()">
          <option value="0">All Projects</option>        </select>
        <button type="submit">Switch</button>
        <input type="hidden" name="do" value="details" />
        <input type="hidden" value="1" name="switch" />
              </div>
    </form>
</div>

<ul id="pm-menu-list">
    <li class="first">
      <a id="toplevellink" href="https://awesomewm.org/bugs/index.php?do=toplevel&amp;project=1">Overview</a>
    </li>

    <li>
    <a id="homelink"
        href="https://awesomewm.org/bugs/index.php?project=1&amp;do=index">Tasklist</a>
    </li>

    
    
        <li>
    <a id="roadmaplink"
        href="https://awesomewm.org/bugs/index.php?do=roadmap&amp;project=1">Roadmap</a>
    </li>
    
    
    </ul>
</div>

    
    <div id="content">
      <div id="showtask">
        <form action="https://awesomewm.org/bugs/index.php" method="get">
          <div>
            <button type="submit">Show Task #</button>
            <input id="taskid" name="show_task" class="text" type="text" size="10" accesskey="t" />
          </div>
        </form>
      </div>

      <div class="clear"></div>
            <div id="intromessage">Welcome to awesome bug tracking system.</div>
      <div id="taskdetails">
<span id="navigation">   <del>&#160;<a href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=858" title="Not a bug | monitor height, as used in layout calculations, &quot;shrinks&quot; when u | 100%"  id = "prev" accesskey = "p" class = "closedtasklink">Previous task</a>&#160;</del>     |     <a href="https://awesomewm.org/bugs/index.php?project=1&amp;do=index">Tasklist</a>
    </span>

  <h2 class="summary severity3">
	 FS#503 - awesome &quot;steals&quot; gnome systray even when its systray is disabled  </h2>

  <div id="fineprint">
	 Attached to Project:
	 <a href="/bugs/index.php?project=1">awesome</a>
	 <br />
	 Opened by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=295">Stefano Zacchiroli (zack)</a>     	 - Tuesday, 21 April 2009, 12:40 GMT 	 	 <br />
	 Last edited by  <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=289">Uli Schlachter (psychon)</a>	 - Thursday, 22 July 2010, 07:28 GMT 	   </div>

  <table><tr><td id="taskfieldscell">
  <div id="taskfields">
	 <table>
		<tr>
		  <th id="tasktype">Task Type</th>
		  <td headers="tasktype">Bug Report</td>
		</tr>
		<tr>
		  <th id="category">Category</th>
		  <td headers="category">
			 			 Core		  </td>
		</tr>
		<tr>
		  <th id="status">Status</th>
		  <td headers="status">
			 			 Closed			 		  </td>
		</tr>
		<tr>
		  <th id="assignedto">Assigned To</th>
		  <td headers="assignedto">
			 			 No-one			 		  </td>
		</tr>
		<tr>
		  <th id="os">Operating System</th>
		  <td headers="os">Linux</td>
		</tr>
		<tr>
		  <th id="severity">Severity</th>
		  <td headers="severity">Medium</td>
		</tr>
		<tr>
		  <th id="priority">Priority</th>
		  <td headers="priority">Normal</td>
		</tr>
		<tr>
		  <th id="reportedver">Reported Version</th>
		  <td headers="reportedver">3.2.1</td>
		</tr>
		<tr>
		  <th id="dueversion">Due in Version</th>
		  <td headers="dueversion">
			 			 Undecided			 		  </td>
		</tr>
		<tr>
		  <th id="duedate">Due Date</th>
		  <td headers="duedate">
			 Undecided		  </td>
		</tr>
		<tr>
		  <th id="percent">Percent Complete</th>
		  <td headers="percent">
			 <img src="https://awesomewm.org/bugs/themes/Bluey/percent-100.png"
				title="100% complete"
				alt="100%" />
		  </td>
		</tr>
        <tr class="votes">
		  <th id="votes">Votes</th>
		  <td headers="votes">
                    <a href="javascript:showhidestuff('showvotes')">7 </a>
          <div id="showvotes" class="hide">
              <ul class="reports">
                              <li><a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=485">John Smith (jmpc)</a> (2010-05-12)</li>
                              <li><a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=484">Matias Aguirre (omab)</a> (2010-05-12)</li>
                              <li><a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=483">Pablo Hoffman (pablohoffman)</a> (2010-05-12)</li>
                              <li><a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=482">Andres Moreira (andrix)</a> (2010-05-12)</li>
                              <li><a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=481">Daniel Graña (dangra)</a> (2010-05-12)</li>
                              <li><a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=369">Akos Ladanyi (akos.ladanyi)</a> (2009-10-04)</li>
                              <li><a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=330">Angel Olivera (redondos)</a> (2009-07-08)</li>
                            </ul>
          </div>
                              </td>
        </tr>
        <tr>
		  <th id="private">Private</th>
		  <td headers="private">
                        No            
                      </td>
        </tr>
        	 </table>
  </div>

  </td><td>

  <div id="taskdetailsfull">
	 <h3 class="taskdesc">Details</h3>
     <div id="taskdetailstext">I&#039;m using awesome 3.2.1 (Debian/unstable) with GNOME. In GNOME, I&#039;m using the legacy systray applet and hence I&#039;ve disabled awesome&#039; own systray by commenting out the corresponding line in rc.lua.<br />
<br />
Nevertheless, the GNOME systray seems not to allow new applications to appear there, which in turn seems to block some application to start. For instance, running pigdin shows now window on the screen, while according to ps and strace pidgin is in fact running. Other applications which register to the systray (I&#039;ve tried, for instance, with skype) exhibit a similar behaviour.<br />
<br />
I&#039;m able to reproduce the problem also with no user rc.lua, so I&#039;m not attaching mine. The only other change I&#039;ve in the system-wide rc.lua is to disable naughty, because I want to use GNOME&#039;s notifications instead of awesome&#039;s. I&#039;m attaching my system wide rc.lua.<br />
<br />
<br />
<br />
I don&#039;t know if it is related or not, but I haven&#039;t (yet) found the proper way of having GNOME run awesome as its window manager. The gconf tip reported on the wiki does not make gnome-session start awesome. Hence I&#039;ve tried adding it as a startup program, but that plays badly with the systray applet (coincidence?) making systray-ed applications not register in it (mainly 2: GNOME&#039;s network manager and power manager). Hence my last attempt of using awesome with GNOME was stuck at not having any window manager started by gnome-session and starting awesome by hand at the end of the GNOME bootstrap procedure.<br />
<br />
Also, no matter how I start awesome (by hand or from GNOME&#039;s session), it does not get killed when leaving GNOME.<br />
<br />
Many thanks for your efforts!<br />
Cheers.</div>

         <div class="attachments">
          <a title="rc.lua" href="?getfile=168" >
                <img src="https://awesomewm.org/bugs/themes/Bluey/mime/text.png" alt="" title="text/plain" />
            &nbsp;&nbsp;
            rc.lua
                  </a>
                  (15.7 KiB)
          <br />
    </div>
  
  </div>

  </td></tr></table>

  <div id="taskinfo">
	 <div id="taskdeps">
		<b>This task depends upon</b>
		<br />
		
		<br class="DoNotPrint" />

		
			 </div>

	 <div id="taskblocks">
        			 </div>
  </div>

    <div id="taskclosed">
      Closed by&nbsp;&nbsp;<a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=289">Uli Schlachter (psychon)</a><br />
      Thursday, 22 July 2010, 07:28 GMT <br />
      <strong>Reason for closing:</strong> &nbsp;Fixed<br />
            <strong>Additional comments about closing:</strong> &nbsp;commit
f47b81699617f23d8bcef74f714c9a52ea6550b5
<br />
Author: Daniel Graña
&lt;dangra@gmail.com&gt;<br />
Date:   Fri May 21 16:18:12 2010
-0300<br />
<br />
    Register systray only if systray
widgets are attached. (<del>&#160;<a
href="https://awesomewm.org/bugs/index.p
hp?do=details&amp;task_id=503"
title="Fixed | awesome
&quot;steals&quot; gnome systray even
when its systray is disabled | 100%" 
class =
"closedtasklink">FS#503</a>&#160;</del>)
<br />
    <br />
    Signed-off-by: Daniel Graña
&lt;dangra@gmail.com&gt;<br />
    Signed-off-by: Uli Schlachter
&lt;psychon@znc.in&gt;        </div>
  
  <div id="actionbuttons">
	 
	 
	 	   </div>
</div>
<ul id="submenu">
    <li id="commentstab">
  <a href="#comments">Comments (28)</a>
  </li>
  
  <li id="relatedtab">
  <a href="#related">Related Tasks (0/0)</a>
  </li>

  
  </ul>
<div id="comments" class="tab">
    <em>
    <a name="comment1190" id="comment1190"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment1190">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=295">Stefano Zacchiroli (zack)</a> -
    Tuesday, 21 April 2009, 14:53 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">Some more info. I&#039;m able to reproduce the problem not only using gnome-session, but also with the attached ~/.Xsession .<br />
<br />
A &quot;workaround&quot; that seems to work is to have awesome start *after* the systray spawned by the gnome-panel is started<br />
(and that&#039;s the reason of the sleep in the attached .Xsession) *and* remove the systray from the panel to add a new one.<br />
In the new one, apps will be able to appear.<br />
<br />
If awesome starts before the GNOME&#039;s systray, apps like gnome-power-manager and network manager get &quot;lost&quot; and do not<br />
appear in the systray not even if that is removed and readded to the panel.</div></div>

      <div class="attachments">
          <a title="Xsession" href="?getfile=169" >
                <img src="https://awesomewm.org/bugs/themes/Bluey/mime/text.png" alt="" title="text/plain" />
            &nbsp;&nbsp;
            Xsession
                  </a>
                  (0.2 KiB)
          <br />
    </div>
  

    <em>
    <a name="comment1215" id="comment1215"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment1215">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=1">Julien Danjou (jd)</a> -
    Monday, 27 April 2009, 11:57 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">You can&#039;t totally disable the awesome systray. And it assumes generally it is the only one to run.</div></div>

  
    <em>
    <a name="comment1242" id="comment1242"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment1242">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=295">Stefano Zacchiroli (zack)</a> -
    Thursday, 21 May 2009, 09:40 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">Is that by design?<br />
<br />
I would personally be very interested in having a way to use the GNOME&#039;s one, and I believe other users would be interested.<br />
Of course I&#039;m willing to help, but I wouldn&#039;t enroll in the task if you consider this a &quot;feature&quot; that will not be changed in the future.<br />
<br />
Thanks for your feedback,<br />
Cheers.</div></div>

  
    <em>
    <a name="comment1297" id="comment1297"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment1297">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=330">Angel Olivera (redondos)</a> -
    Wednesday, 08 July 2009, 00:22 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">Stefano&#039;s workaround didn&#039;t work for me; in fact, I&#039;ve been starting awesome much later than gnome-panel all this time.<br />
<br />
jd, are there plans for implementing this?<br />
<br />
Thanks.</div></div>

  
    <em>
    <a name="comment1962" id="comment1962"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment1962">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=481">Daniel Graña (dangra)</a> -
    Thursday, 13 May 2010, 20:01 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">The attached patch adds a --nosystray command line option to disable systray.<br />
<br />
I used instruction here<a href=" http://awesome.naquadah.org/wiki/Quickly_Setting_up_Awesome_with_Gnome#Normally"> http://awesome.naquadah.org/wiki/Quickly_Setting_up_Awesome_with_Gnome#Normally</a>,<br />
but modified ~/.config/autostart/awesome.desktop as:<br />
<br />
[Desktop Entry]<br />
 Version=1.0<br />
 Type=Application<br />
 Name=Awesome<br />
 Comment=The awesome launcher!<br />
 TryExec=awesome<br />
 Exec=awesome --nosystray<br /></div></div>

      <div class="attachments">
          <a title="awesome-FS503.patch" href="?getfile=312" >
                <img src="https://awesomewm.org/bugs/themes/Bluey/mime/text.png" alt="" title="text/plain" />
            &nbsp;&nbsp;
            awesome-FS503.patch
                  </a>
                  (1.5 KiB)
          <br />
    </div>
  

    <em>
    <a name="comment1964" id="comment1964"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment1964">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=289">Uli Schlachter (psychon)</a> -
    Friday, 14 May 2010, 15:06 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">That patch doesn&#039;t really make sure that systray.c later on causes invalid &quot;stuff&quot; to happen. After all it&#039;s now working with uninitialized variables (globalconf.screen.tab[phys_screen].systray.window), isn&#039;t it?</div></div>

  
    <em>
    <a name="comment1965" id="comment1965"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment1965">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=481">Daniel Graña (dangra)</a> -
    Wednesday, 19 May 2010, 20:34 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">This hacky patch does the job without leaving uninitialized variables around, but I don&#039;t know if passing a command line option is acceptable to disable systray in awesome.<br />
<br />
diff --git a/systray.c b/systray.c<br />
index 1f573ee..1e9cde3 100644<br />
--- a/systray.c<br />
+++ b/systray.c<br />
@@ -85,7 +85,7 @@ systray_init(int phys_screen)<br />
     p_delete(&amp;atom_systray_r);<br />
 <br />
     xcb_set_selection_owner(globalconf.connection,<br />
-                            globalconf.screens.tab[phys_screen].systray.window,<br />
+                            XCB_NONE, /* globalconf.screens.tab[phys_screen].systray.window, */<br />
                             atom_systray,<br />
                             XCB_CURRENT_TIME);<br />
 <br /></div></div>

  
    <em>
    <a name="comment1966" id="comment1966"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment1966">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=481">Daniel Graña (dangra)</a> -
    Wednesday, 19 May 2010, 20:36 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">Was thinking at using command line option and a bool systray_is_active in globalconf. Doing xcb_set_selection_owner based on systray_is_active flag.<br />
<br />
Sounds good?<br /></div></div>

  
    <em>
    <a name="comment1967" id="comment1967"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment1967">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=481">Daniel Graña (dangra)</a> -
    Wednesday, 19 May 2010, 21:32 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">here it is:<br />
* adds command line option --nosystray<br />
* adds globalconf.systray_is_active (much like xinerama_is_active and have_xtest)<br />
* it disables systray by not selecting it to receive notifications<br />
* patch at<a href=" http://gist.github.com/406858"> http://gist.github.com/406858</a></div></div>

  
    <em>
    <a name="comment1968" id="comment1968"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment1968">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=481">Daniel Graña (dangra)</a> -
    Wednesday, 19 May 2010, 22:12 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">For future references, Gregor Best suggests registering the systray only if a systray widget is created.<br />
see<a href=" http://www.mail-archive.com/<a href="mailto:awesome@naquadah.org">awesome@naquadah.org</a>/msg01437.html"> http://www.mail-archive.com/<a href="mailto:awesome@naquadah.org">awesome@naquadah.org</a>/msg01437.html</a><br /></div></div>

  
    <em>
    <a name="comment1969" id="comment1969"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment1969">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=481">Daniel Graña (dangra)</a> -
    Wednesday, 19 May 2010, 22:14 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">no idea why previous link got broken, here it is again<br /><a href="
http://www.mail-archive.com/<a href="mailto:awesome@naquadah.org">awesome@naquadah.org</a>/msg01437.html">
http://www.mail-archive.com/<a href="mailto:awesome@naquadah.org">awesome@naquadah.org</a>/msg01437.html</a></div></div>

  
    <em>
    <a name="comment1971" id="comment1971"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment1971">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=481">Daniel Graña (dangra)</a> -
    Thursday, 20 May 2010, 14:25 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">Citing email about the topic:<br />
<br />
===============================================================================<br />
On Thu, May 20, 2010 at 5:27 AM, Julien Danjou &lt;<a href="mailto:julien@danjou.info">julien@danjou.info</a>&gt; wrote:<br />
Hi Daniel,<br />
<br />
&gt; I was trying to use awesome as wm behind gnome replacing metacity but found<br />
&gt; the bug better described by<br />
&gt; <del>&#160;<a href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503" title="Fixed | awesome &quot;steals&quot; gnome systray even when its systray is disabled | 100%"  class = "closedtasklink">FS#503</a>&#160;</del>&lt;http://awesome.naquadah.org/bugs/index.php?do=details&amp;task_id=503&gt;.<br />
&gt; I am trying to fix it now (or part of it at least).<br />
&gt;<br />
&gt; I cloned awesome source, prepared a patch and need someone to review it. My<br />
&gt; latests comments has some notes about the patch, see<br />
&gt;<a href=" http://awesome.naquadah.org/bugs/index.php?do=details&amp;task_id=503#comment1967"> http://awesome.naquadah.org/bugs/index.php?do=details&amp;task_id=503#comment1967</a><br />
<br />
Well, the patch seems valid, unfortunately I&#039;m not very comfortable with it.<br />
The ideal patch would be to enable systray window only at systray widget<br />
creation, and destroy it on widget destruction.<br />
<br />
Sounds sensible, I was hanging around in #awesome to get direction to proper fix and now I got it.<br />
Will try to submit a patch in the coming days.<br />
<br />
thanks!<br />
Daniel.<br />
===============================================================================</div></div>

  
    <em>
    <a name="comment1972" id="comment1972"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment1972">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=289">Uli Schlachter (psychon)</a> -
    Thursday, 20 May 2010, 15:34 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">Lots of new comments... Oo <br />
<br />
For using xcb_set_selection_owner() with XCB_NONE: This will cause a BadWindow error from the server, wouldn&#039;t it make more sense to just not call that function at all, if it&#039;s not needed? :P<br />
On the patch from github (http://gist.github.com/406858): Same comment, just move the call to xcb_set_selection_owner() inside of the if ().<br />
<br />
Besides that, this patch seems like it does the job it was meant to do.<br />
<br />
For committing this patch to awesome, it would be easier if you could append the result of &#039;git format-patch origin/HEAD..&#039; to this bug. Jd can the just &#039;git am&#039; those (if he likes them...).</div></div>

  
    <em>
    <a name="comment1975" id="comment1975"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment1975">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=481">Daniel Graña (dangra)</a> -
    Thursday, 20 May 2010, 16:11 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">@psychon<br />
<br />
Patch was rejected by jd but he suggested proper fix:<br />
  | The ideal patch would be to enable systray window only at systray widget<br />
  | creation, and destroy it on widget destruction.<br />
<br />
&gt;For using xcb_set_selection_owner() with XCB_NONE: This will cause a BadWindow <br />
&gt; error from the server, wouldn&#039;t it make more sense to just not call that function<br />
&gt; at all, if it&#039;s not needed? :P<br />
<br />
I am learning xcb/X in the process of fixing this issue, so thanks for pointing the difference.<br />
I choose between not doing any selection (not calling xcb_set_selection_owner) versus clear the selection <br />
using XCB_NONE just like systray_cleanup does hoping that doing clearing the selection won&#039;t fail.<br />
<br />
If calling with XCB_NONE fails at systray_init, it will fail at systray_cleanup too <br />
but nobody will notice it because it&#039;s just leaving awesome.<br />
<br />
But as said, patch needs to be reworked to register/select systray only if a systray widget is created.<br />
<br />
thanks!</div></div>

  
    <em>
    <a name="comment1977" id="comment1977"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment1977">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=289">Uli Schlachter (psychon)</a> -
    Thursday, 20 May 2010, 19:57 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">Ah, sorry seems like I mis-read the man page for XSetSelectionOwner.<br />
<br />
Wouldn&#039;t setting it to XCB_NONE also break gnome since it effectively unsets gnome&#039;s selection? (Each selection is a shared thing on the X server, all apps access the same &quot;stuff&quot;)<br />
I don&#039;t know much about this either, but clearing it seems wrong.</div></div>

  
    <em>
    <a name="comment1981" id="comment1981"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment1981">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=481">Daniel Graña (dangra)</a> -
    Friday, 21 May 2010, 02:04 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">thanks for pointing the manpage, something useful I extracted from it: <br />
<br />
| If the client that is the owner of a selection is later terminated (that is, its connection is closed) or if<br />
| the owner window it has specified in the request is later destroyed, the owner of the selection automatically reverts to None<br />
<br />
Does it means that clearing the selection at systray_cleanup is not required?</div></div>

  
    <em>
    <a name="comment1982" id="comment1982"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment1982">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=481">Daniel Graña (dangra)</a> -
    Friday, 21 May 2010, 05:02 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">Please, review patch that register systray only if a systray widget is created and attached to a wibox.<br />
* Patch at<a href=" http://gist.github.com/408472"> http://gist.github.com/408472</a><br />
* Adds a `registered` flag to screent_t.systray structure (commonly acceded by globalconf.screens.tab[phys_screen].systray)<br />
* Splits systray_init in two functions, one that initialize screen_t.systray and the other that register systray with X (named systray_register)<br />
<br />
feedback welcome!</div></div>

  
    <em>
    <a name="comment1983" id="comment1983"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment1983">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=289">Uli Schlachter (psychon)</a> -
    Saturday, 22 May 2010, 07:48 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">+ screen_t screen = globalconf.screens.tab[phys_screen];<br />
<br />
Doesn&#039;t that copy the screen_t? That would mean that all changes that are made to it will be lost.<br />
Also, didn&#039;t you mean to move &quot;screen.systray.registered = true;&quot; into systray_register()? (I would also move the check of &#039;if(!screen.systray.registered = true)&#039; into systray_register())<br />
Also, is systray_init() still needed? I think creating the window can be moved into systray_register().</div></div>

  
    <em>
    <a name="comment2002" id="comment2002"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment2002">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=481">Daniel Graña (dangra)</a> -
    Friday, 28 May 2010, 12:48 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">On Wed, May 26, 2010 at 3:50 PM, Uli Schlachter &lt;<a href="mailto:psychon@znc.in">psychon@znc.in</a>&gt; wrote:<br />
<br />
&gt; -----BEGIN PGP SIGNED MESSAGE-----<br />
&gt; Hash: SHA256<br />
&gt;<br />
&gt; Am 24.05.2010 21:57, Daniel Gra=C3=B1a wrote:<br />
&gt; &gt;<a href="  http://gist.github.com/412326">  http://gist.github.com/412326</a><br />
&gt;<br />
&gt; I wonder what happens if I have two wiboxes attached to the same screen..=<br />
.?<br />
&gt; (First one got a systray, second one doesnt)<br />
&gt;<br />
&gt; When the first one updates, it will register the systray. When the second<br />
&gt; one<br />
&gt; updates it will unregister it again. Next time the first one updates...<br />
&gt;<br />
&gt; Did I miss sth?<br />
&gt;<br />
<br />
Hi, it looks like a valid bug report to me :(<br />
<br />
And based on it, another patch approach<br /><a href="
http://github.com/dangra/awesome/commit/d872bf...&lt;http://github.com/dangra/">
http://github.com/dangra/awesome/commit/d872bf...&lt;http://github.com/dangra/</a>=<br />
awesome/commit/d872bf46073fcda5bf68008b8d699bd0d780fe31&gt;<br />
<br />
The notable things about this new patch:<br />
* `wibox_t` gains a new field named `systray_count` to track the number of<br />
systray widgets attached per wibox<br />
* `wibox_systray_refresh` updates `wibox-&gt;systray_count` but do not<br />
register/unregister screen systray<br />
* Added `systray_refresh` function that is called after `wibox_refresh` in<br />
`awesome_refresh` cb</div></div>

  
    <em>
    <a name="comment2003" id="comment2003"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment2003">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=481">Daniel Graña (dangra)</a> -
    Friday, 28 May 2010, 12:51 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">Need to complain, current FS fails parsing urls and emails, version running at FS site hasn&#039;t this bugs and it also allows to preview comments before submitting.</div></div>

  
    <em>
    <a name="comment2036" id="comment2036"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment2036">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=474">lotus (lotus)</a> -
    Tuesday, 08 June 2010, 18:58 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">guys what have u done on me. now if i start fbpanel i get only the error : &quot;&quot;tray: another systray already running&quot; in the console. this can not be.</div></div>

  
    <em>
    <a name="comment2037" id="comment2037"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment2037">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=289">Uli Schlachter (psychon)</a> -
    Tuesday, 08 June 2010, 19:14 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">@lotus: Uhm, what does have this to do with this report?</div></div>

  
    <em>
    <a name="comment2040" id="comment2040"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment2040">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=474">lotus (lotus)</a> -
    Wednesday, 09 June 2010, 06:20 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">this concern to this because since some changes in the git tree, i am not anymore possible to start fbpanel, because it only accept one systray.</div></div>

  
    <em>
    <a name="comment2043" id="comment2043"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment2043">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=200">Gregor Best (farhaven)</a> -
    Wednesday, 09 June 2010, 12:56 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">The systray is allocated at startup since Awesome 3.0. That is almost 2 years ago and by no means happened recently. You can start fbpanel if you remove the systray from its configuration, and as for Awesome always grabbing the systray, we&#039;re working on that :)</div></div>

  
    <em>
    <a name="comment2044" id="comment2044"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment2044">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=481">Daniel Graña (dangra)</a> -
    Wednesday, 09 June 2010, 16:00 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">@lotus: you can check this email thread about progress in this ticket<a href=" http://www.mail-archive.com/<a href="mailto:awesome-devel@naquadah.org">awesome-devel@naquadah.org</a>/msg05032.html"> http://www.mail-archive.com/<a href="mailto:awesome-devel@naquadah.org">awesome-devel@naquadah.org</a>/msg05032.html</a><br />
<br />
A shortcut, latest patch to fix this issue is<a href=" http://github.com/dangra/awesome/commit/a513e321bd445d2dfc6dca4af9f22535b6b32324"> http://github.com/dangra/awesome/commit/a513e321bd445d2dfc6dca4af9f22535b6b32324</a><br />
<br />
Could be cool if you help testing it, thanks.</div></div>

  
    <em>
    <a name="comment2046" id="comment2046"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment2046">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=289">Uli Schlachter (psychon)</a> -
    Friday, 11 June 2010, 16:22 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">Despite some grammar stuff (&quot;Has wibox an attached systray&quot;) I feel like systray_refresh() seems bad. It needlessly walks all wiboxes on each update. Wouldn&#039;t it make more sense to call systray_register() directly from wibox_refresh() *only* when the has_systray value changes?<br />
(Also, wtf @ the foreach loop in systray_refresh()? Are you really or-ing value into a boolean? Just set that one to true and &quot;break;&quot;?!)<br />
<br />
Besides that, the code seems sane. Now let&#039;s do some testing...<br />
Results:<br />
- Alltray sucks. Never use it!<br />
- Patch doesn&#039;t seem to break my config<br />
- Alltray annoyed me enough so that I don&#039;t feel like adding/removing systrays dynamically, sorry<br />
<br />
I&#039;d vote for jd testing this himself and/or merging the next version of the patches (really, no need to walk all the wiboxes).<br />
<br />
Oh and sorry if I sound harsh, I don&#039;t mean stuff as unfriendly as I write it.8</div></div>

  
    <em>
    <a name="comment2051" id="comment2051"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment2051">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=481">Daniel Graña (dangra)</a> -
    Friday, 11 June 2010, 17:17 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">&gt; Despite some grammar stuff (&quot;Has wibox an attached systray&quot;)<br />
yes, my english grammar sucks, suggestions? &quot;Has systray attached&quot; or just &quot;Has systray&quot;?<br />
<br />
&gt; I feel like systray_refresh() seems bad. It needlessly walks all wiboxes on each update.<br />
&gt; Wouldn&#039;t it make more sense to call systray_register() directly from wibox_refresh() *only* when the has_systray value changes?<br />
<br />
True, it walks and register/unregistry at every awesome_refresh. Will work on fixing this.<br />
<br />
&gt; (Also, wtf @ the foreach loop in systray_refresh()? Are you really or-ing value into a boolean? Just set that one to true and &quot;break;&quot;?!)<br />
<br />
Yeah, I found it pretty easy to use `foreach` to iterate the array but though that a plain `break` won&#039;t work as `foreach` expand to a nested `for` loop.<br />
I will change it for a plain `for` loop and break there.<br />
<br />
&gt; Besides that, the code seems sane. Now let&#039;s do some testing...<br />
&gt; Results:<br />
&gt; - Alltray sucks. Never use it!<br />
<br />
bad, but luckily not related to this patch.<br />
<br />
&gt; - Patch doesn&#039;t seem to break my config<br />
<br />
I take that as a +1 that it works using builtin systray widgets.<br />
<br />
&gt; - Alltray annoyed me enough so that I don&#039;t feel like adding/removing systrays dynamically, sorry<br />
<br />
I didn&#039;t understood this, you mean that you didn&#039;t tested adding/removing systrays dinamically like attaching/deattaching lua systray widget while awesome is running?<br />
<br />
&gt; I&#039;d vote for jd testing this himself and/or merging the next version of the patches (really, no need to walk all the wiboxes).<br />
<br />
Ok, but keep sending feedback, I will try to get it into acceptable form even if I don&#039;t reach the ideal of one-systray-per-screen.<br />
<br />
&gt; Oh and sorry if I sound harsh, I don&#039;t mean stuff as unfriendly as I write it.8<br />
<br />
No prob, the coin is flipping. thanks for your feedback!<br /></div></div>

  
    <em>
    <a name="comment2052" id="comment2052"
      href="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#comment2052">
      <img src="https://awesomewm.org/bugs/themes/Bluey/comment.png"
        title="Link to this comment" alt="" />
    </a>
    Comment by <a href="https://awesomewm.org/bugs/index.php?do=user&amp;area=users&amp;id=289">Uli Schlachter (psychon)</a> -
    Friday, 11 June 2010, 17:35 GMT   </em>

  <span class="DoNotPrint">
    
      </span>
  <div class="comment">
    <div class="commenttext">Suggestion:<br />
&quot;Is there a systray in this wibox&quot; or something like that.<br />
<br />
Also, I didn&#039;t know that foreach() does some nested loops. Perhaps that code could be moved into its own static function so that one can use &quot;return&quot; as a replacement for &quot;break&quot;?<br />
<br />
&gt; I didn&#039;t understood this, you mean that you didn&#039;t tested adding/removing systrays dinamically like attaching/deattaching lua systray widget while awesome is running?<br />
Yeah, exactly.</div></div>

  
  
  </div>
<div id="related" class="tab">
  <table>    <tr><td>
    <form method="post" action="https://awesomewm.org/bugs/index.php?do=details&amp;task_id=503#related" >
        <table id="tasks_related" class="userlist">
        <tr>
          <th>
            <a href="javascript:ToggleSelected('tasks_related')">
              <img title="Toggle Selected" alt="Toggle Selected" src="https://awesomewm.org/bugs/themes/Bluey/kaboodleloop.png" width="16" height="16" />
            </a>
          </th>
          <th>Tasks related to this task (0)</th>
        </tr>
                <tr>
          <td colspan="2">
            <input type="hidden" name="action" value="remove_related" />
            <input type="hidden" name="task_id" value="503" />
            <button type="submit">Remove</button>
          </td>
        </tr>
        </table>
    </form>
    </td><td>
    
    <table id="duplicate_tasks" class="userlist">
        <tr>
          <th>Duplicate tasks of this task (0)</th>
        </tr>
            </table>
    </td></tr>
  </table>

  </div>
<div id="history" class="tab">
  <h3>Loading...</h3>
</div>
    </div>
    <p id="footer">
       <!-- Please don't remove this line - it helps promote Flyspray -->
       <a href="http://flyspray.org/" class="offsite">Powered by Flyspray</a>
    </p>
  </div>
  </body>
</html>
